<!DOCTYPE html>
<html>

<head>
    <title>Video Stream</title>
</head>

<body>
    <style>
        .video-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: fill;
        }
    </style>
    <div class="video-container">
        <video id="current-video" autoplay muted playsinline src="/video_feed" type="video/mp4"></video>
        <video id="next-video" muted playsinline src="/video_feed?index=1" type="video/mp4"
            style="display: none"></video>
    </div>
    <script>
        const video_1 = document.getElementById('current-video');
        const video_2 = document.getElementById('next-video');

        let currentVideo = video_1;

        let index = 1;
        let bufferSize = 0;

        setIndex();

        async function setIndex() {
            let buffer = await fetch(`/buffer_size`).then(res => res.json());
            if (buffer > 5) index = buffer - 5;
        }

        video_1.addEventListener('ended', async () => {
            await switchVideo(video_1, video_2);
        });

        video_2.addEventListener('ended', async () => {
            await switchVideo(video_2, video_1);
        });

        async function switchVideo(current, next) {
            index += 1;

            current.style.display = 'none';
            next.style.display = 'block';
            current.src = `/video_feed?index=${index}`;
            current.load();
            next.play();

            currentVideo = next;
            adjustPlaybackSpeed();
        }

        async function adjustPlaybackSpeed() {
            const bufferSize = await fetch(`/buffer_size?index=${index}`).then(res => res.json());
            let remainingTime = currentVideo.duration - currentVideo.currentTime + (bufferSize * 20);
            currentVideo.playbackRate = Math.min(10, (parseInt(remainingTime * 1.5) / 100));
            console.log('remainingTime: ', remainingTime, 'playbackRate:', currentVideo.playbackRate);
        }

        setInterval(adjustPlaybackSpeed, 2000);
    </script>
</body>

</html>